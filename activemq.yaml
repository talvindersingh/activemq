---
- name: Deploy ActiveMQ on Minikube
  hosts: minikube
  become: true
  tasks:
    - name: Install kubectl
      apt:
        name: kubectl
        state: present

    - name: Install Minikube
      shell: curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/

    - name: Start Minikube
      command: minikube start

    - name: Create ActiveMQ network namespace
      command: minikube ssh -- sudo ip netns add activemq

    - name: Enable IP forwarding in the ActiveMQ network namespace
      command: minikube ssh -- sudo ip netns exec activemq sysctl -w net.ipv4.ip_forward=1

    - name: Apply Primary ActiveMQ deployment
      kubectl:
        kubeconfig: ~/.kube/config
        src: primary-activemq-deployment.yml
        state: present

    - name: Apply Backup ActiveMQ deployment
      kubectl:
        kubeconfig: ~/.kube/config
        src: backup-activemq-deployment.yml
        state: present

    - name: Apply Primary ActiveMQ service
      kubectl:
        kubeconfig: ~/.kube/config
        src: primary-activemq-service.yml
        state: present

    - name: Apply Backup ActiveMQ service
      kubectl:
        kubeconfig: ~/.kube/config
        src: backup-activemq-service.yml
        state: present
